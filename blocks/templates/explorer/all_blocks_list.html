{% extends 'base.html' %}

{% load humanize static %}

{% block title %}
Latest Blocks
{% endblock %}

{% block content %}
{#    <div class="row">#}
{#        <div class="col-md-10">#}
{#            {% include 'pagination.html' %}#}
{#        </div>#}
{#    </div>#}
    <div class="row spacer">
        <div id="blocks-table-container" class="col-md-8">
            <table id="all-blocks-table" class="table table-striped table-bordered table-hover table-condensed">
                <thead>
                    <tr>
                        <td>Height</td>
                        <td>Hash</td>
                        <td>Age</td>
                        <td>Num. Trans</td>
                        <td>SDD</td>
                        <td>Valid</td>
                    </tr>
                </thead>
                <tbody>
                    {% for block in object_list %}
                        <tr class="{% if not block.is_valid %}warning{% endif %}">
                            {% include 'explorer/fragments/block.html' %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{#    <div class="row">#}
{#        <div class="col-md-10">#}
{#            {% include 'pagination.html' %}#}
{#        </div>#}
{#    </div>#}
{% endblock %}

{% block afterbody %}
    <script>
        $(function() {
            const webSocketBridge = new channels.WebSocketBridge();
            webSocketBridge.connect('/all_blocks_list/');

            var blocks_table_container = $('#blocks-table-container');

            webSocketBridge.socket.addEventListener('open', function() {
                blocks_table_container.on('scroll', function () {
                    console.log('scrolling');
                    if ($(this).scrollTop() + $(this).innerHeight() >= $(this)[0].scrollHeight) {
                        var last_height = $("#all-blocks-table>tbody tr:last td:first").text();
                        alert(last_height);
                        webSocketBridge.stream('next_blocks').send(
                            {'host': window.location.hostname, 'last_height': last_height}
                        );
                    }
                });

                webSocketBridge.listen(function (data, channel) {
                    var message_type = data["message_type"];
                });
            });
        });
    </script>
{% endblock %}
